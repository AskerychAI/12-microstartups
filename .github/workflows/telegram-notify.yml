name: Notify Telegram on New Post

on:
  push:
    branches:
      - main
    paths:
      - 'content/posts/**/*.md'
  workflow_dispatch:  # –ü–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å –≤—Ä—É—á–Ω—É—é –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # –Ω—É–∂–Ω–∞ –ø–æ–ª–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è

      - name: Detect and Send New Posts
        id: process
        run: |
          # –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
          echo "Event name: ${{ github.event_name }}"
          echo "Before SHA: ${{ github.event.before }}"
          echo "Current SHA: ${{ github.sha }}"
          
          # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –∏–∑–º–µ–Ω–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
          if [ "${{ github.event_name }}" == "push" ] && [ -n "${{ github.event.before }}" ] && [ "${{ github.event.before }}" != "0000000000000000000000000000000000000000" ]; then
            echo "Using git diff with before/after commits"
            CHANGED_FILES=$(git diff --name-only --diff-filter=AM ${{ github.event.before }} ${{ github.sha }} | grep '^content/posts/.*\.md$' || true)
          else
            echo "Using git diff with HEAD~1"
            CHANGED_FILES=$(git diff --name-only --diff-filter=AM HEAD~1 HEAD | grep '^content/posts/.*\.md$' || true)
          fi
          
          echo "Changed files:"
          echo "$CHANGED_FILES"
          
          if [ -z "$CHANGED_FILES" ]; then
            echo "No new posts found"
            echo "new_posts=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "new_posts=true" >> $GITHUB_OUTPUT
          
          POST_COUNT=0
          
          # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞–∂–¥—ã–π –Ω–æ–≤—ã–π –ø–æ—Å—Ç –∏ —Å—Ä–∞–∑—É –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º
          for file in $CHANGED_FILES; do
            if [ -f "$file" ]; then
              # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º _index.md
              if [[ "$file" == *"_index.md"* ]]; then
                continue
              fi
              
              echo "Processing file: $file"
              
              # –ò–∑–≤–ª–µ–∫–∞–µ–º frontmatter
              TITLE=$(grep -m1 "^title:" "$file" | sed 's/^title: *"\(.*\)".*/\1/' | sed "s/^title: *'\(.*\)'.*/\1/" | sed 's/^title: *\(.*\)/\1/' | sed 's/^"\(.*\)"$/\1/' | sed "s/^'\(.*\)'$/\1/")
              DESCRIPTION=$(grep -m1 "^description:" "$file" | sed 's/^description: *"\(.*\)".*/\1/' | sed "s/^description: *'\(.*\)'.*/\1/" | sed 's/^description: *\(.*\)/\1/' | sed 's/^"\(.*\)"$/\1/' | sed "s/^'\(.*\)'$/\1/")
              DRAFT=$(grep -m1 "^draft:" "$file" | sed 's/^draft: *\(.*\)/\1/' | tr '[:upper:]' '[:lower:]')
              
              echo "Title: $TITLE"
              echo "Description: $DESCRIPTION"
              echo "Draft: $DRAFT"
              
              # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —á–µ—Ä–Ω–æ–≤–∏–∫–∏
              if [ "$DRAFT" = "true" ]; then
                echo "Skipping draft: $file"
                continue
              fi
              
              # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º slug –∏–∑ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞
              SLUG=$(basename "$file" .md)
              
              # –§–æ—Ä–º–∏—Ä—É–µ–º URL
              BASE_URL="https://ch12ms.online"
              POST_URL="${BASE_URL}/posts/${SLUG}/"
              
              # –ò–∑–≤–ª–µ–∫–∞–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç –ø–æ—Å–ª–µ frontmatter
              CONTENT_START=$(awk '/^---$/{if(++count==2) exit} count==2' "$file" | tail -n +2)
              
              # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º SUMMARY_TEXT
              SUMMARY_TEXT=""
              
              # –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1: –ò—Å–ø–æ–ª—å–∑—É–µ–º description –∏–∑ frontmatter
              if [ -n "$DESCRIPTION" ] && [ "$DESCRIPTION" != "null" ] && [ "$DESCRIPTION" != "" ]; then
                SUMMARY_TEXT="$DESCRIPTION"
              else
                # –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2: –ò—â–µ–º —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å <!--more-->
                if echo "$CONTENT_START" | grep -q "<!--more-->"; then
                  SUMMARY_TEXT=$(echo "$CONTENT_START" | sed 's/<!--more-->.*//' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
                else
                  # –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 3: –ë–µ—Ä–µ–º –ø–µ—Ä–≤—ã–µ 500 —Å–∏–º–≤–æ–ª–æ–≤ —Ç–µ–∫—Å—Ç–∞ (–±–µ–∑ markdown —Ä–∞–∑–º–µ—Ç–∫–∏)
                  SUMMARY_TEXT=$(echo "$CONTENT_START" | \
                    sed 's/!\[.*\](.*)//g' | \
                    sed 's/\[\(.*\)\](.*)/\1/g' | \
                    sed 's/#\{1,6\}[[:space:]]*//g' | \
                    sed 's/\*\*//g' | \
                    sed 's/\*//g' | \
                    sed 's/```[^`]*```//g' | \
                    sed 's/`[^`]*`//g' | \
                    head -c 500)
                  
                  # –î–æ–±–∞–≤–ª—è–µ–º –º–Ω–æ–≥–æ—Ç–æ—á–∏–µ –µ—Å–ª–∏ —Ç–µ–∫—Å—Ç –æ–±—Ä–µ–∑–∞–Ω
                  if [ ${#CONTENT_START} -gt 500 ]; then
                    SUMMARY_TEXT="${SUMMARY_TEXT}..."
                  fi
                fi
              fi
              
              # –û—á–∏—â–∞–µ–º —Å–∞–º–º–∞—Ä–∏ –æ—Ç –ª–∏—à–Ω–∏—Ö –ø—Ä–æ–±–µ–ª–æ–≤ –∏ –ø–µ—Ä–µ–Ω–æ—Å–æ–≤ —Å—Ç—Ä–æ–∫
              SUMMARY_TEXT=$(echo "$SUMMARY_TEXT" | tr '\n' ' ' | sed 's/[[:space:]]\+/ /g' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
              
              echo "Sending post: $TITLE"
              echo "URL: $POST_URL"
              
              # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –ø–µ—Ä–µ–Ω–æ—Å–∞–º–∏ —Å—Ç—Ä–æ–∫
              MESSAGE=$(printf "üÜï *–ù–æ–≤—ã–π –ø–æ—Å—Ç –Ω–∞ –±–ª–æ–≥–µ*\n\n**%s**\n\n" "$TITLE")
              
              if [ -n "$SUMMARY_TEXT" ] && [ "$SUMMARY_TEXT" != "null" ] && [ "$SUMMARY_TEXT" != "" ]; then
                MESSAGE=$(printf "%s%s\n\n" "$MESSAGE" "$SUMMARY_TEXT")
              fi
              
              MESSAGE=$(printf "%süìñ [–ß–∏—Ç–∞—Ç—å –ø–æ–ª–Ω–æ—Å—Ç—å—é ‚Üí](%s)" "$MESSAGE" "$POST_URL")
              
              # –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è JSON (jq -Rs —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ä–µ–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫)
              MESSAGE_JSON=$(printf "%s" "$MESSAGE" | jq -Rs .)
              
              # –§–æ—Ä–º–∏—Ä—É–µ–º JSON –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
              PAYLOAD=$(jq -n \
                --arg chat_id "$TELEGRAM_CHAT_ID" \
                --argjson text "$MESSAGE_JSON" \
                '{chat_id: $chat_id, text: $text, parse_mode: "Markdown", disable_web_page_preview: false}')
              
              # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ Telegram
              RESPONSE=$(curl -s -w "\nHTTP_CODE:%{http_code}" -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
                -H "Content-Type: application/json" \
                -d "$PAYLOAD")
              
              HTTP_CODE=$(echo "$RESPONSE" | grep "HTTP_CODE:" | cut -d: -f2)
              RESPONSE_BODY=$(echo "$RESPONSE" | sed '/HTTP_CODE:/d')
              
              echo "HTTP Code: $HTTP_CODE"
              echo "Telegram API response: $RESPONSE_BODY"
              
              # –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—Ç–≤–µ—Ç
              if echo "$RESPONSE_BODY" | jq -e '.ok == true' > /dev/null 2>&1; then
                echo "‚úÖ Message sent successfully"
                POST_COUNT=$((POST_COUNT + 1))
              else
                ERROR_DESC=$(echo "$RESPONSE_BODY" | jq -r '.description // "Unknown error"' 2>/dev/null || echo "Parse error")
                echo "‚ùå Error sending message: $ERROR_DESC"
                echo "Full response: $RESPONSE_BODY"
                # –ù–µ –≤—ã—Ö–æ–¥–∏–º —Å –æ—à–∏–±–∫–æ–π, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –ø–æ—Å—Ç–æ–≤
              fi
              
              # –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏
              sleep 1
            fi
          done
          
          echo "‚úÖ –£—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ $POST_COUNT –ø–æ—Å—Ç(–æ–≤) –≤ Telegram"
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
