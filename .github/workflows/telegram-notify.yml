name: Notify Telegram on New Post

on:
  push:
    branches:
      - main
    paths:
      - 'content/posts/**/*.md'

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # –Ω—É–∂–Ω–∞ –∏—Å—Ç–æ—Ä–∏—è –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è

      - name: Detect and Process New Posts
        id: process
        run: |
          # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –∏–∑–º–µ–Ω–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
          if [ "${{ github.event_name }}" == "push" ]; then
            CHANGED_FILES=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep '^content/posts/.*\.md$' || true)
          else
            CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD | grep '^content/posts/.*\.md$' || true)
          fi
          
          if [ -z "$CHANGED_FILES" ]; then
            echo "new_posts=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "new_posts=true" >> $GITHUB_OUTPUT
          
          # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞–∂–¥—ã–π –Ω–æ–≤—ã–π –ø–æ—Å—Ç
          for file in $CHANGED_FILES; do
            if [ -f "$file" ]; then
              # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º _index.md
              if [[ "$file" == *"_index.md"* ]]; then
                continue
              fi
              
              # –ò–∑–≤–ª–µ–∫–∞–µ–º frontmatter
              TITLE=$(grep -m1 "^title:" "$file" | sed 's/^title: *"\(.*\)".*/\1/' | sed "s/^title: *'\(.*\)'.*/\1/" | sed 's/^title: *\(.*\)/\1/' | sed 's/^"\(.*\)"$/\1/' | sed "s/^'\(.*\)'$/\1/")
              DESCRIPTION=$(grep -m1 "^description:" "$file" | sed 's/^description: *"\(.*\)".*/\1/' | sed "s/^description: *'\(.*\)'.*/\1/" | sed 's/^description: *\(.*\)/\1/' | sed 's/^"\(.*\)"$/\1/' | sed "s/^'\(.*\)'$/\1/")
              DRAFT=$(grep -m1 "^draft:" "$file" | sed 's/^draft: *\(.*\)/\1/' | tr '[:upper:]' '[:lower:]')
              
              # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —á–µ—Ä–Ω–æ–≤–∏–∫–∏
              if [ "$DRAFT" = "true" ]; then
                echo "Skipping draft: $file"
                continue
              fi
              
              # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º slug –∏–∑ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞
              SLUG=$(basename "$file" .md)
              
              # –§–æ—Ä–º–∏—Ä—É–µ–º URL
              BASE_URL="https://ch12ms.online"
              POST_URL="${BASE_URL}/posts/${SLUG}/"
              
              # –ò–∑–≤–ª–µ–∫–∞–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç –ø–æ—Å–ª–µ frontmatter
              CONTENT_START=$(awk '/^---$/{if(++count==2) exit} count==2' "$file" | tail -n +2)
              
              # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º SUMMARY_TEXT
              SUMMARY_TEXT=""
              
              # –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1: –ò—Å–ø–æ–ª—å–∑—É–µ–º description –∏–∑ frontmatter
              if [ -n "$DESCRIPTION" ] && [ "$DESCRIPTION" != "null" ] && [ "$DESCRIPTION" != "" ]; then
                SUMMARY_TEXT="$DESCRIPTION"
              else
                # –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2: –ò—â–µ–º —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å <!--more-->
                if echo "$CONTENT_START" | grep -q "<!--more-->"; then
                  SUMMARY_TEXT=$(echo "$CONTENT_START" | sed 's/<!--more-->.*//' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
                else
                  # –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 3: –ë–µ—Ä–µ–º –ø–µ—Ä–≤—ã–µ 500 —Å–∏–º–≤–æ–ª–æ–≤ —Ç–µ–∫—Å—Ç–∞ (–±–µ–∑ markdown —Ä–∞–∑–º–µ—Ç–∫–∏)
                  SUMMARY_TEXT=$(echo "$CONTENT_START" | \
                    sed 's/!\[.*\](.*)//g' | \
                    sed 's/\[\(.*\)\](.*)/\1/g' | \
                    sed 's/#\{1,6\}[[:space:]]*//g' | \
                    sed 's/\*\*//g' | \
                    sed 's/\*//g' | \
                    sed 's/```[^`]*```//g' | \
                    sed 's/`[^`]*`//g' | \
                    head -c 500)
                  
                  # –î–æ–±–∞–≤–ª—è–µ–º –º–Ω–æ–≥–æ—Ç–æ—á–∏–µ –µ—Å–ª–∏ —Ç–µ–∫—Å—Ç –æ–±—Ä–µ–∑–∞–Ω
                  if [ ${#CONTENT_START} -gt 500 ]; then
                    SUMMARY_TEXT="${SUMMARY_TEXT}..."
                  fi
                fi
              fi
              
              # –û—á–∏—â–∞–µ–º —Å–∞–º–º–∞—Ä–∏ –æ—Ç –ª–∏—à–Ω–∏—Ö –ø—Ä–æ–±–µ–ª–æ–≤ –∏ –ø–µ—Ä–µ–Ω–æ—Å–æ–≤ —Å—Ç—Ä–æ–∫
              SUMMARY_TEXT=$(echo "$SUMMARY_TEXT" | tr '\n' ' ' | sed 's/[[:space:]]\+/ /g' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
              
              # –§–æ—Ä–º–∏—Ä—É–µ–º JSON –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
              POST_DATA=$(cat <<EOF
          {
            "title": $(echo "$TITLE" | jq -Rs .),
            "summary": $(echo "$SUMMARY_TEXT" | jq -Rs .),
            "url": "$POST_URL"
          }
          EOF
          )
              
              # –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ—Å—Ç–∞
              echo "$POST_DATA" >> posts_data.jsonl
            fi
          done
          
          # –ï—Å–ª–∏ —Ñ–∞–π–ª —Å –¥–∞–Ω–Ω—ã–º–∏ –ø—É—Å—Ç, –∑–Ω–∞—á–∏—Ç –Ω–æ–≤—ã—Ö –ø–æ—Å—Ç–æ–≤ –Ω–µ—Ç
          if [ ! -f posts_data.jsonl ] || [ ! -s posts_data.jsonl ]; then
            echo "new_posts=false" >> $GITHUB_OUTPUT
            exit 0
          fi

      - name: Send to Telegram
        if: steps.process.outputs.new_posts == 'true'
        run: |
          # –ß–∏—Ç–∞–µ–º –∫–∞–∂–¥—ã–π –ø–æ—Å—Ç –∏–∑ —Ñ–∞–π–ª–∞ –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º
          while IFS= read -r line; do
            TITLE=$(echo "$line" | jq -r '.title')
            SUMMARY=$(echo "$line" | jq -r '.summary')
            URL=$(echo "$line" | jq -r '.url')
            
            # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
            MESSAGE="üÜï *–ù–æ–≤—ã–π –ø–æ—Å—Ç –Ω–∞ –±–ª–æ–≥–µ*\n\n"
            MESSAGE="${MESSAGE}*${TITLE}*\n\n"
            
            if [ -n "$SUMMARY" ] && [ "$SUMMARY" != "null" ] && [ "$SUMMARY" != "" ]; then
              MESSAGE="${MESSAGE}${SUMMARY}\n\n"
            fi
            
            MESSAGE="${MESSAGE}üìñ [–ß–∏—Ç–∞—Ç—å –ø–æ–ª–Ω–æ—Å—Ç—å—é ‚Üí](${URL})"
            
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ Telegram
            curl -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
              -H "Content-Type: application/json" \
              -d "{
                \"chat_id\": \"${TELEGRAM_CHAT_ID}\",
                \"text\": $(echo "$MESSAGE" | jq -Rs .),
                \"parse_mode\": \"Markdown\",
                \"disable_web_page_preview\": false
              }"
            
            # –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏
            sleep 1
          done < posts_data.jsonl
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}

      - name: Summary
        if: steps.process.outputs.new_posts == 'true'
        run: |
          POST_COUNT=$(wc -l < posts_data.jsonl)
          echo "‚úÖ –£—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ $POST_COUNT –ø–æ—Å—Ç(–æ–≤) –≤ Telegram"
